---
title: "Labor Market Analysis part 1"
author: "y_bib"
format:
  pdf:
    include-in-header: 
      text: |
        \usepackage{float}
        \usepackage{makecell}
        
editor: visual
---

# Labor Market Canada

**Labor market survey results** provided by Statistics Canada contain information on employment status, type of employment, gender, marital status, and whether children are present at home. For employed individuals, data on wages, hours worked, overtime, the type and field of occupation are included and etc. For part-time workers, the survey additionally explores the reasons for part-time employment. For unemployed individuals, the survey provides insights into the reasons for not working and related factors.

**Goals of the Analysis:**

-   For employed people: provide a description and test the statistical significance of wage differences based on gender, immigrant status, age, and other relevant variables.

-   Study which factors are most crucial in determining wage levels: education, place of living, occupation type and field, gender, age and etc.

-   Examine differences between women and men, immigrants and non-immigrants in terms of overtime work, part-time employment, and unemployment rates.

```         
## 
```

```{r}
#| message: false
#| warning: false
#| include: false
#loading libraries
library(plyr)
library(dplyr)
library(ggplot2)
library(ggpmisc)
library(patchwork)
library(descr)
library(stringr) # for formatting input data - working with strings
library(pdftools) # reading pdf file
# library(lubridate) handling datas ant time - did not use it
library(dbscan) # for clustering
library(tidyr)
library(pivottabler) # for pivot tables
library(gt) # tables
library(umap) #clustering

#reading date from Stat Ca
labor<-read.table(file='data/pub0325.txt',header=TRUE,sep="\t",stringsAsFactors = TRUE)

#indicating columns as factors
names<-as.vector(colnames(labor),mode="character")
names_factor<-setdiff(names,c("REC_NUM","FINALWT","PAIDOT","UNPAIDOT",
        "XTRAHRS","WKSAWAY","UHRSMAIN","AHRSMAIN",
        "UTOTHRS","ATOTHRS","HRSAWAY","TENURE","PREVTEN","HRLYEARN"))

labor[names_factor] <- lapply(labor[names_factor], as.factor)

labor$IMMIG<-revalue(labor$IMMIG, c("1" = "Immigrant,not more 10y", "2" = "Immigrant,more 10y", "3"="Non-immigrant"))
labor$GENDER <- revalue(labor$GENDER, c("1" = "Male", "2" = "Female"))
labor$FTPTMAIN<-revalue(labor$FTPTMAIN,c("1"="Full-time","2"="Part-time"))

AGE_12_labels <- c(
  "1" = "15 to 19",
  "2" = "20 to 24",
  "3" = "25 to 29",
  "4" = "30 to 34",
  "5" = "35 to 39",
  "6" = "40 to 44",
  "7" = "45 to 49",
  "8" = "50 to 54",
  "9" = "55 to 59",
  "10" = "60 to 64",
  "11" = "65 to 69",
  "12" = "70+"
)

# Reasons for part time. WHYPT field
WHYPT_labels <- c(
  "0" = "Other reasons",
  "1" = "Own illness or disability",
  "2" = "Caring for children",
  "3" = "Other personal or family responsibilities",
  "4" = "Going to school",
  "5" = "Personal preference",
  "6" = "Business cond. or could not find full-time work, looked for it in last month",
"7"=	"Business cond. or could not find full-time work, did not look for it in last month")


```

## Wages depending on gender

Mean wages vs gender

```{r}
#| echo: false
#| message: false
#| warning: false

#hour rate* usual hours=income  vs gender

tapply(0.01*labor$HRLYEARN*labor$UTOTHRS, labor$GENDER , mean, na.rm = TRUE)
boxplot(HRLYEARN ~ GENDER ,data=labor, ylim=c(0,15000))
```

Median wages vs gender

```{r}
#| echo: false
#| message: false
#| warning: false

#hour rate* usual hours=income  vs gender

tapply(0.01*labor$HRLYEARN*labor$UTOTHRS, labor$GENDER , median, na.rm = TRUE)
#boxplot(HRLYEARN ~ GENDER ,data=labor, ylim=c(0,15000))
```

Both mean and median show that male workers earn more compared to female workers.

So let us see if female workers actually work less hours compared to male workers.

```{r}
#| echo: false
#| message: false
#| warning: false
#| results: 'asis'



#function for Latex table output since it is repeated often
latex_table <- function(data, title = "Table", annotation= NULL) {
  # Create gt table
  tab <- data %>%
    gt() %>%
    tab_header(title = title)
  
  # Convert to LaTeX and set float position to [H]
  latex_code <- as.character(as_latex(tab))
  latex_code <- gsub("\\\\begin\\{table\\}", "\\\\begin{table}[H]", latex_code)
  
  # Output LaTeX code
  cat(latex_code)
}

#---------------------------------------------------------

#means for extra hours depending on gender

# Summarize mean of XTRAHRS by GENDER
tab<-tapply(labor$XTRAHRS, labor$GENDER, mean, na.rm = TRUE)
summary_labor<-as.data.frame(tab)
colnames(summary_labor)<-c("Mean of extra hours")

summary_labor <- cbind(GENDER = rownames(summary_labor), summary_labor)

rownames(summary_labor) <- NULL

latex_table(summary_labor, "Mean of extra hours by gender")

#full-time vs part-time for each gender

tab <- table(labor$GENDER, labor$FTPTMAIN)

# Convert to data frame keeping wide structure
summary_labor <- as.data.frame.matrix(tab)

# Optionally add row names as a proper column
summary_labor <- cbind(GENDER = rownames(summary_labor), summary_labor)
rownames(summary_labor) <- NULL


latex_table(summary_labor, "Full-time anf part-time workers by gender")

# reasons for part-time vs gender


tab<-xtabs(~ WHYPT+GENDER, data=labor )

summary_labor <- as.data.frame.matrix(tab)

summary_labor$Reason <- WHYPT_labels  # 


latex_table(summary_labor, "Reasons for part-time work by gender")





#Conclusion : women stay away from work taking care of the children approx 10x then men
```

We nay immediately notice conclusion: women stay away from work taking care of the children approx 10x then men

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false
#| results: asis
#hour rate* usual hours=income  vs type of employment
#tapply(0.01*labor$HRLYEARN, labor$PERMTEMP, mean, na.rm = TRUE)
#tapply(0.01*labor$HRLYEARN, labor$PERMTEMP , median, na.rm = TRUE)
# Permanent or temporary job (field PERMTEMP)
# 1	Permanent
# 2	Temporary, seasonal job
# 3	Temporary, term or contract job
# 4	Temporary, casual or other temporary jobs


```

## Wages depend on age and gender

It is clear that family matter affects the hours and wages of female workers. Let us see how wages depend on the age and gender.

### Unemployment vs gender
```{r}

source("script.R")
```


### Wages vs age (using linear regression and poly approximation)

First we check how wages depend on age of workers of both genders.

```{r}
#| echo: false
#| message: false
#| warning: false
#| include: true

#tapply(labor$HRLYEARN, labor$AGE_12 , mean, na.rm = TRUE)
tmp <- tapply(labor$HRLYEARN, labor$AGE_12, mean, na.rm = TRUE)

#with(labor, tapply(0.01 * HRLYEARN * UTOTHRS, AGE_12, mean, na.rm = TRUE))

# Create data frame; AGE_12 numeric for modeling, AGE_GROUP factor for labels
df <- data.frame(
  AGE_12 = as.numeric(names(tmp)),        # numeric age codes (1,2,3...)
  salary = as.numeric(tmp)
)
df$AGE_GROUP <- factor(df$AGE_12, levels = as.numeric(names(AGE_12_labels)), labels = AGE_12_labels)

# Fit polynomial regression on numeric AGE_12
model <- lm(salary ~ poly(AGE_12, 2), data = na.omit(df))
df$pred <- predict(model)

ggplot(df, aes(x = AGE_GROUP, y = salary, color = "black")) +
  geom_point(size = 2, show.legend = FALSE) +    # no legend for points
  geom_line(aes(y = pred, group = 1), color = "blue", size = 0.5) +
  labs(title = "Wages vs Age", x = "Age Group", y = "Mean Wages") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 15, hjust = 1))

```

## Wages vs age (using linear and quadratic polynÐ¾mial regressions)

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: true

# LINEAR REGRESSION for SALARY vs AGE (AGE_12 is treated as numeric)
model <- lm(0.01 * HRLYEARN * UTOTHRS ~ as.numeric(AGE_12), data = labor)
#model

# SECOND ORDER POLYNOMIAL REGRESSION
#lm(formula = 0.01 * HRLYEARN * UTOTHRS ~ poly(as.numeric(AGE_12), 2), data = labor)

# Scatter plot with linear and polynomial regression lines
p1 <- labor %>%
  ggplot(aes(x = as.numeric(AGE_12), y = 0.01 * HRLYEARN * UTOTHRS)) +
  geom_point(color = "orange") +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  geom_smooth(method = "lm", formula = y ~ poly(x, 2), se = FALSE, color = "blue") +
  scale_x_continuous(
    breaks = 1:length(AGE_12_labels),
    labels = AGE_12_labels
  ) +
  labs(x = "AGE", y = "wages means: actual hours") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 15, hjust = 1))


# Boxplot by AGE_12 factor
p2 <- labor %>%
  ggplot(aes(x = AGE_12, y = 0.01 * HRLYEARN * UTOTHRS)) +
  geom_boxplot(fill = "orange") +
  scale_x_discrete(labels = AGE_12_labels) +  # <-- show long labels for age
  labs(x = "AGE", y = "wages means: actual hours") +
  theme_bw()+  
  theme(axis.text.x = element_text(angle = 15, hjust = 1))

# Display plots side by side
p1 / p2

```

## Wages vs age for males and females

```{r}
#| echo: false
#| message: false
#| warning: false


# plot shows salary (based on usual hours and usual wages) by gender
pl1<-labor %>%
  ggplot(aes(x = AGE_12, y = 0.01 * HRLYEARN * UTOTHRS, color = GENDER)) +
  stat_summary(fun = mean, geom = "point", size = 2) +
  stat_summary(fun = mean, geom = "line", aes(group = GENDER), color="grey", linewidth = 0.3) +
    scale_x_discrete(labels = AGE_12_labels) +  # <-- show long labels
  labs(x = "AGE", y = "wages means: usual hours") +
  theme_bw()+  
  theme(axis.text.x = element_text(angle = 15, hjust = 1))

```

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: true

#hyst plot showing paid plus unpaid extra hours for Females and Males during the week of sampling


pl2<-labor %>%
  ggplot(aes(x = AGE_12, y = 0.01 * HRLYEARN *ATOTHRS, color = GENDER)) +
  stat_summary(fun = mean, geom = "point", size = 2) +
  stat_summary(fun = mean, geom = "line", aes(group = GENDER), color = "grey", linewidth = 0.3) +
  scale_x_discrete(labels = AGE_12_labels) +  # <-- show long labels for age
  labs(x = "AGE", y = "wages means: actual hours") +
  theme_bw()+  
  theme(axis.text.x = element_text(angle = 15, hjust = 1))
pl1 / pl2


```

#Wages vs other factors

## Wages depend on immigrant status

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: true

#hour rate* usual hours=income  vs immigrant status

tapply(0.01*labor$HRLYEARN*labor$UTOTHRS, labor$IMMIG , mean, na.rm = TRUE)
tapply(0.01*labor$HRLYEARN*labor$UTOTHRS, labor$IMMIG , summary, na.rm = TRUE)
boxplot(0.01*HRLYEARN*UTOTHRS ~ IMMIG ,data=labor)
boxplot(HRLYEARN ~ IMMIG ,data=labor)
boxplot(UTOTHRS ~ IMMIG ,data=labor)

ggplot(data=labor, aes(x=IMMIG,y=0.01*HRLYEARN*UTOTHRS))+
  geom_violin(draw_quantiles = c(0.25, 0.5, 0.75))+
  theme_bw() +
  labs(x="Immigration status",y="Salary")
```

## Wages vs tenure (using linear regression)

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: true

#idea: income=hours*rate for different ages, non-linear dependence vs linear regression

#LINEAR REGRESSION for SALARY vs TENURE
model<-lm(formula = 0.01*HRLYEARN*UTOTHRS~TENURE,data=labor)

labor %>% ggplot(aes(x=TENURE,y=0.01*HRLYEARN*UTOTHRS,color = GENDER))+
geom_point( size = 0.3)+
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(x = "Tenure in monthes", y = "Salary") +
  theme_minimal()


```



# What factors are crutial for wages

## Wages clustering : using UMAP and K-means

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: true


tmp.data <- labor[, c("HRLYEARN","PAIDOT","UNPAIDOT",
        "XTRAHRS","UHRSMAIN","AHRSMAIN",
        "UTOTHRS","ATOTHRS","HRSAWAY","TENURE","AGE_12")]
keep_rows <- complete.cases(tmp.data)
tmp.data$AGE_12 <- as.numeric(tmp.data$AGE_12)
tmp.data <- tmp.data[keep_rows, ]



umap_result<-umap(as.matrix(tmp.data))

# Convert umap layout to data frame
umap_df <- as.data.frame(umap_result)
colnames(umap_df) <- c("UMAP1", "UMAP2")

# try colors defined by K-means clusterization
# Combine with original data 
combined <- cbind(umap_df, tmp.data)

# Correlations: how much each variable contributes to the axis UMAP1, UMAP2
cor(combined[, c("UMAP1", "UMAP2")], combined[, -c(1,2)], use = "complete.obs")

clusters <- kmeans(umap_result, centers = 3)$cluster

umap_df$col <- as.factor(clusters)

ggplot(umap_df, aes(x = UMAP1, y = UMAP2, color = col)) +
  geom_point(size = 2, alpha = 0.7) +
  theme_bw() +
  labs(title = "UMAP Clustering", x = "UMAP 1", y = "UMAP 2", color = "Cluster")

# Factor column for coloring 
tmp.labels <- factor(ifelse(0.01 * tmp.data$HRLYEARN * tmp.data$UTOTHRS > 10500, "Yes", "No"))
#tmp.labels <- labor[1:3000,][keep_rows,"GENDER"]

umap_df$col <- tmp.labels 

# Plot with ggplot2
ggplot(umap_df, aes(x = UMAP1, y = UMAP2, color = col)) +
  geom_point(size = 1.5) +
  labs(title = "UMAP Projection", x = "UMAP 1", y = "UMAP 2", color = "Factor") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))


```

## Clusterization using DBSCAN

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false

library(mclust)


tmp.data <- labor[, c("HRLYEARN","PAIDOT","UNPAIDOT",
        "XTRAHRS","UHRSMAIN","AHRSMAIN",
        "UTOTHRS","ATOTHRS","HRSAWAY","TENURE","AGE_12")]
keep_rows<-complete.cases(tmp.data)
tmp.data$AGE_12<-as.numeric(tmp.data$AGE_12)
tmp.data <- tmp.data[keep_rows, ]

mclust_result <- Mclust(tmp.data)

# summary and method  Mclust if needed
#table(mclust_result$classification) 

# summary(mclust_result)
# mclust_result$G  # Number of components selected
# mclust_result$modelName 

clusters <- mclust_result$classification

#visualization using umap
umap_result<-umap(as.matrix(tmp.data))

# Convert umap layout to data frame
umap_df <- as.data.frame(umap_result)
colnames(umap_df) <- c("UMAP1", "UMAP2")

umap_df$col <- as.factor(clusters)

ggplot(umap_df, aes(x = UMAP1, y = UMAP2, color = col)) +
  geom_point(size = 2, alpha = 0.7) +
  theme_bw() +
  labs(title = "UMAP Clustering", x = "UMAP 1", y = "UMAP 2", color = "Cluster")

# only one cluster -> statistical conclusion that no meaningful subgrouping was found
```

## Multidimensional linear regression

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false

#rows with no NAs
complete_labor <- labor[complete.cases(labor[,c("UTOTHRS","AGE_12","EDUC", "GENDER","COWMAIN","MARSTAT","AGYOWNK","NAICS_21","NOC_10","PROV") ]), ]

#we consider age a numeric variable
complete_labor$AGE_12<-as.numeric(complete_labor$AGE_12)

#null_model <- lm(HRLYEARN ~ 1, data = complete_labor)

#linear regression model  and the summary
model <- lm(HRLYEARN ~ GENDER+EDUC +COWMAIN+AGYOWNK+AGE_12+NOC_10+PROV , data = complete_labor)

summary(model)

alt_model <- lm(UTOTHRS ~ GENDER+EDUC +COWMAIN+AGYOWNK+NAICS_21+PROV , data = complete_labor)

summary(alt_model)



#BIC testing what model is more prefferable

# alt_model <- lm(HRLYEARN ~ GENDER+EDUC +COWMAIN+AGYOWNK , data = complete_labor)
# 
# summary(alt_model)
# 
BIC(model, alt_model)


#correlation between numeric parameters to see their contribution to the lin model

chisq.test(table(labor$AGE_12, labor$MARSTAT))
chisq.test(table(labor$AGYOWNK, labor$MARSTAT))
chisq.test(table(labor$AGYOWNK, labor$AGE_12))
chisq.test(table(labor$NAICS_21, labor$NOC_10))

chisq.test(table(labor$NAICS_21, labor$NOC_43))

library(DescTools)

EtaSq(aov(HRLYEARN ~ PROV+GENDER, data = labor))  # Strength of association

cor(labor$UTOTHRS, labor$HRLYEARN, use = "complete.obs")


#step_model <- step(null_model, scope = list(lower = null_model, upper = full_model), direction = "both",na.action = na.omit)
```

## Part-time workers study

```{r}
#| eval: false
#| include: false

#| echo: false
#| message: false
#| warning: false

# PART TIME vs GENDER

# reasons for part-time vs gender
tab<-xtabs(~ GENDER + WHYPT, data=labor )
tab
#Conclusion : women stay away from work taking care of the chieldren approx 10x then men

```

```{r}
#| eval: false
#| include: false

#| echo: false
#| message: false
#| warning: false

df_tab <- as.data.frame(tab)

df_tab %>%
 # filter(WHYPT %in% c("2","3","6")) %>%
  ggplot( aes(x = WHYPT , y=Freq, color=GENDER)) +
  geom_point(size=3)+
  theme(legend.position="top")+
  labs(x = "Why part-time job", 
       caption = "0	- Other reasons
1 -	Own illness or disability
2	- Caring for children
3	- Other personal or family responsibilities
4	- Going to school
5	- Personal preference
6	- Business conditions or could not find full-time work, looked for full-time work in last month
7	- Business conditions or could not find full-time work, did not look for full-time work in last month
", 
       y = "Number")+
  theme_bw() +
  theme(
    plot.caption = element_text(hjust = 0, size = 10)
  )
```

```{r}
#| eval: false
#| include: false

#| echo: false
#| message: false
#| warning: false

# GENDER vs REASONS FOR LEAVING JOB
tab<-xtabs(~ GENDER + WHYLEFTN, data=labor )
tab
df_tab <- as.data.frame(tab)

df_tab %>%
  filter(WHYLEFTN %in% c("1","2","3","4","5")) %>%
  ggplot( aes(x = WHYLEFTN , y=Freq, color=GENDER)) +
  geom_point(size=3)+
  theme(legend.position="top")+
  labs(x = "Why left job in the last 12 months", 
       caption="
02	Job leavers, caring for children
03	Job leavers, pregnancy
04	Job leavers, personal or family responsibilities
05	Job leavers, going to school",
       y = "Number")+
theme(
  plot.caption = element_text(hjust = 0, size = 10)
)

# Conclusion: there are more males leaving work for school then females 
#
# part time going to school males 1664, females 2349
# left work because of the going to school males 810, females 738
# possible trend: males less likely work full or part-time during attending school
#compared to females
```

# Bootstrap: non-weighted and weighted

```{r}
#| eval: false
#| message: false
#| warning: false
#| include: false

# Confidence intervals via non-weighted bootstrap  
# seed <- 1234
# set.seed(seed_value)

  
mean.function <- function(x, index) {
    d <- x[index]     # This first line will go in ever bootstrap function you make.
    return(mean(d,na.rm = TRUE))  
  }

BootHR<-boot(data = labor$HRLYEARN, statistic = mean.function, R=1000)
head(BootHR$t)
BootHR.graph <- data.frame(xbar=BootHR$t)

ggplot(BootHR.graph, aes(x=0.01*xbar)) +
  geom_histogram(color="darkblue", fill="lightblue") + 
  ggtitle('Estimated Sampling distribution of Means of Hour Rate (HRLYEARN)' )

# 0.95 confidence interval
quantile( BootHR$t, probs=c(.025, .975) ) 
boot.ci(BootHR, type = "perc", conf = 0.95)  
```
